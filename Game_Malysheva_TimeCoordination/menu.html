<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Главное меню - Лампочки</title>
  <link rel="stylesheet" href="css/menu.css">
  <link rel="stylesheet" href="css/style.css">
</head>
<body>
<div class="container">
  <!-- Экран выбора профиля (показывается если нет текущего игрока) -->
  <div id="profileSelectionScreen" class="profile-selection-screen hidden">
    <div class="profile-selection-container">
      <h2 class="profile-selection-title">Выберите профиль</h2>
      <div id="profilesList" class="profiles-list">
        <!-- Список профилей будет заполнен через JavaScript -->
      </div>
      <div class="profile-selection-actions">
        <button onclick="createNewProfile()" class="btn btn-primary btn-large" aria-label="Создать новый профиль">
          <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 8px;">
            <path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"/>
          </svg>
          Создать новый профиль
        </button>
      </div>
    </div>
  </div>

  <!-- Панель пользователя -->
  <div class="user-panel loading" id="userPanel">
    <!-- Placeholder для предотвращения CLS -->
    <div class="user-info" style="visibility: hidden;">
      <div class="avatar-preview avatar-0 user-avatar-large"></div>
      <div class="user-details">
        <div class="user-name">Загрузка...</div>
        <div class="user-level">Уровень</div>
        <div class="user-sublevels">Подуровней пройдено: 0/13</div>
      </div>
      <button class="btn-logout" style="visibility: hidden;">
        <svg viewBox="0 0 24 24"><path d="M16,17V14H9V10H16V7L21,12L16,17M14,2A2,2 0 0,1 16,4V6H14V4H5V20H14V18H16V20A2,2 0 0,1 14,22H5A2,2 0 0,1 3,20V4A2,2 0 0,1 5,2H14Z"/></svg>
      </button>
    </div>
    <div class="stats-grid" style="visibility: hidden;">
      <div class="stat-card"><div class="stat-number">0</div><div class="stat-name">Игр сыграно</div></div>
      <div class="stat-card"><div class="stat-number">0</div><div class="stat-name">Лучший счет</div></div>
      <div class="stat-card"><div class="stat-number">0</div><div class="stat-name">Всего очков</div></div>
      <div class="stat-card"><div class="stat-number">0</div><div class="stat-name">Подуровней пройдено</div></div>
    </div>
  </div>

  <!-- Карусель режимов игры -->
  <div class="carousel-container">
    <div class="carousel-track" id="carouselTrack">
      <!-- Карточка 1: Классическая игра -->
      <div class="carousel-card">
        <div class="mode-card">
          <div class="mode-header">
            <div class="mode-icon">
              <svg viewBox="0 0 24 24">
                <path d="m14.09 16h.91c6.643 0 9-3.5 9-6.5a3.5 3.5 0 0 0 -2.84-3.433 7.564 7.564 0 0 0 .409-1 3.887 3.887 0 0 0 -.626-3.458 3.979 3.979 0 0 0 -3.214-1.609h-11.458a3.979 3.979 0 0 0 -3.214 1.612 3.887 3.887 0 0 0 -.626 3.458 7.564 7.564 0 0 0 .409 1 3.5 3.5 0 0 0 -2.84 3.43c0 3 2.357 6.5 9 6.5h.91a5.027 5.027 0 0 1 .09.921v3.079a1.883 1.883 0 0 1 -2 2h-2a1 1 0 0 0 0 2h12a1 1 0 0 0 0-2h-1.994a1.885 1.885 0 0 1 -2.006-2v-3.08a5.025 5.025 0 0 1 .09-.92zm1.636-2.851a23.486 23.486 0 0 0 4.4-5.225 1 1 0 0 0 .374.076 1.5 1.5 0 0 1 1.5 1.5c0 2.176-1.839 4.5-7 4.5h-.056a4.805 4.805 0 0 1 .782-.851zm-6.726.851c-5.161 0-7-2.324-7-4.5a1.5 1.5 0 0 1 1.5-1.5 1 1 0 0 0 .375-.076 23.486 23.486 0 0 0 4.4 5.225 4.805 4.805 0 0 1 .781.851z"/>
              </svg>
            </div>
            <h2 class="mode-title">Классическая игра</h2>
            <p class="mode-description">Проходите уровни последовательно, открывая новые подуровни</p>
          </div>

          <div class="mode-content-wrapper">
            <div class="compact-selection loading" id="compactLevelSelection">
              <!-- Placeholder для уровней -->
              <div class="selection-row" style="visibility: hidden;"><div class="level-indicator"><div class="level-number">1</div><div class="level-name">Уровень</div></div><div class="sublevels-container"><button class="sublevel-btn">1-1</button><button class="sublevel-btn">1-2</button><button class="sublevel-btn">1-3</button></div></div>
              <div class="selection-row" style="visibility: hidden;"><div class="level-indicator"><div class="level-number">2</div><div class="level-name">Уровень</div></div><div class="sublevels-container"><button class="sublevel-btn">2-1</button><button class="sublevel-btn">2-2</button><button class="sublevel-btn">2-3</button></div></div>
              <div class="selection-row" style="visibility: hidden;"><div class="level-indicator"><div class="level-number">3</div><div class="level-name">Уровень</div></div><div class="sublevels-container"><button class="sublevel-btn">3-1</button><button class="sublevel-btn">3-2</button></div></div>
              <div class="selection-row" style="visibility: hidden;"><div class="level-indicator"><div class="level-number">4</div><div class="level-name">Уровень</div></div><div class="sublevels-container"><button class="sublevel-btn">4-1</button></div></div>
            </div>

            <div class="status-legend">
              <div class="status-item">
                <div class="status-color available"></div>
                <span>Доступно</span>
              </div>
              <div class="status-item">
                <div class="status-color completed"></div>
                <span>Пройдено</span>
              </div>
              <div class="status-item">
                <div class="status-color locked"></div>
                <span>Заблокировано</span>
              </div>
              <div class="status-item">
                <div class="status-color active"></div>
                <span>Выбрано</span>
              </div>
            </div>

            <div class="mode-actions">
              <button class="btn btn-primary btn-large" onclick="startSelectedLevel()" id="startClassicBtn" aria-label="Начать классическую игру на выбранном уровне">
                Начать игру
              </button>
              <p style="margin-top: 12px; color: var(--text-muted); font-size: 13px;">
                Выберите уровень и подуровень выше
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Карточка 2: Тренировка -->
      <div class="carousel-card">
        <div class="mode-card">
          <div class="mode-header">
            <div class="mode-icon">
              <svg viewBox="0 0 24 24">
                <path d="m17.009 5.577c.034-2.157.173-2.417.594-2.838.637-.637.607-.62.719-.732 1.016-1.016
                                1.889-1.21 2.375-.819.517.414.214 1.905.214 1.905s1.492-.304 1.905.214c.379.475.201 1.351-.823
                                2.375-.112.112-.094.081-.73.717-.487.487-.663.58-2.846.597l-3.711 3.711c-.391.391-1.023.391-1.414
                                0s-.391-1.023 0-1.414l3.716-3.716zm5.771 3.269c-.085-.544-.583-.917-1.143-.834-.546.085-.919.597-.834
                                1.143.13.834.196 1.792.196 2.846 0 6.561-2.439 9-9 9s-8.999-2.44-8.999-9.001 2.439-9 9-9c1.053 0 2.01.066
                                2.846.197.559.085 1.058-.289 1.143-.834.085-.546-.288-1.057-.834-1.143-.938-.146-1.999-.22-3.154-.22-7.711
                                0-11.001 3.29-11.001 11s3.29 11 11 11 11-3.29 11-11c0-1.173-.072-2.205-.22-3.154zm-8.783-2.737c.041-.551-.372-1.03-.923-1.071-.34-.025-.698-.038-1.074-.038-4.841
                                0-7 2.159-7 7s2.159 7 7 7 7-2.159 7-7c0-.376-.013-.734-.038-1.074-.041-.551-.514-.965-1.071-.923-.551.041-.964.52-.923 1.071.021.293.032.602.032.926 0 3.738-1.262
                                5-5 5s-5-1.262-5-5 1.262-5 5-5c.325 0 .633.01.926.032.54.041 1.03-.373 1.071-.923zm-2.763 3.644c-.373-.404-1.006-.432-1.413-.057-.553.51-.821 1.264-.821 2.304
                                0 1.991 1.009 3 3 3 1.041 0 1.795-.269 2.305-.821.374-.406.349-1.039-.058-1.413-.406-.375-1.038-.349-1.413.057-.049.054-.229.178-.834.178-.878 0-1-.122-1-1
                                0-.605.124-.785.178-.834.406-.375.431-1.007.057-1.413z"/>
              </svg>
            </div>
            <h2 class="mode-title">Тренировка</h2>
            <p class="mode-description">Выберите любой уровень и подуровень для оттачивания мастерства</p>
          </div>

          <div class="mode-content-wrapper">
            <div class="training-selection loading">
              <div class="selection-group">
                <label class="selection-label">Выберите уровень:</label>
                <select class="level-select" id="trainingLevelSelect">
                  <option>Уровень 1</option><option>Уровень 2</option><option>Уровень 3</option><option>Уровень 4</option>
                </select>
              </div>

              <div class="selection-group">
                <label class="selection-label">Выберите подуровень:</label>
                <select class="sublevel-select" id="trainingSublevelSelect">
                  <option>1-1</option><option>1-2</option><option>1-3</option>
                </select>
              </div>

              <div class="training-preview" id="trainingPreview">
                <div class="preview-header">Описание выбранного подуровня:</div>
                <div class="preview-content" id="previewContent">
                  Выберите уровень и подуровень для просмотра описания
                </div>
              </div>
            </div>

            <div class="mode-actions">
              <button class="btn btn-success btn-large" onclick="startTraining()" id="startTrainingBtn" aria-label="Начать тренировочный режим на выбранном уровне">
                Начать тренировку
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Навигация карусели -->
    <div class="carousel-nav">
      <button class="carousel-arrow" onclick="prevSlide()" title="Предыдущая карточка">‹</button>
      <div class="carousel-dots">
        <button class="carousel-dot active" data-slide="0" title="Классическая игра"></button>
        <button class="carousel-dot" data-slide="1" title="Тренировка"></button>
      </div>
      <button class="carousel-arrow" onclick="nextSlide()" title="Следующая карточка">›</button>
    </div>
  </div>

  <!-- Действия меню -->
  <div class="menu-actions">
    <button onclick="window.location.href='results.html'" class="btn btn-secondary" aria-label="Перейти к таблице рейтинга игроков">
      <!-- SVG таблицы рейтинга -->
      <svg viewBox="0 0 24 24">
        <path   fill="#364548"
                d="m8,12c-3.309,0-6-2.691-6-6S4.691,0,8,0s6,2.691,6,6-2.691,6-6,6Zm6.744,12c-.211,0-.422-.067-.6-.2-.34-.254-.481-.696-.354-1.101l.941-3.016-2.377-1.934c-.32-.271-.437-.713-.292-1.107.145-.394.519-.655.938-.655h3.001l1.062-2.98c.146-.391.52-.651.937-.651s.791.26.937.651l1.062,2.98h3.001c.42,0,.795.263.939.657s.026.837-.295,1.108l-2.366,1.927.979,2.98c.134.403-.002.847-.339,1.106-.337.259-.801.277-1.156.046l-2.754-1.793-2.708,1.812c-.168.113-.362.169-.556.169Zm-4.807,0H1c-.552,0-1-.448-1-1,0-4.962,4.038-9,9-9h.937c.346,0,.667.18.85.474.182.294.199.662.045.971-.552,1.11-.832,2.307-.832,3.555s.28,2.444.832,3.555c.154.31.137.678-.045.972-.182.294-.504.473-.85.473Z"/>
      </svg>
      Таблица рейтинга
    </button>
    <button onclick="showInstructions()" class="btn btn-tertiary">
      <!-- SVG инструкции -->
      <svg viewBox="0 0 24 24">
        <path fill="#364548"
                d="m17,10c-3.86,0-7,3.14-7,7s3.14,7,7,7,7-3.14,7-7-3.14-7-7-7Zm0,12c-2.757,0-5-2.243-5-5s2.243-5,5-5,5,2.243,5,5-2.243,5-5,5Zm1-4v2c0,.552-.448,1-1,1s-1-.448-1-1v-2c0-.552.448-1,1-1s1,.448,1,1Zm.5-3.5c0,.828-.672,1.5-1.5,1.5s-1.5-.672-1.5-1.5.672-1.5,1.5-1.5,1.5.672,1.5,1.5Zm-9.5,7.5h-5c-1.103,0-2-.897-2-2s.897-2,2-2h3c.552,0,1-.448,1-1s-.448-1-1-1h-1V2h9c1.654,0,3,1.346,3,3v2c0,.552.448,1,1,1s1-.448,1-1v-2c0-2.757-2.243-5-5-5H5C2.244,0,0,2.243,0,5v15C0,22.206,1.795,24,4,24h5c.552,0,1-.448,1-1s-.448-1-1-1ZM2,5c0-1.302.839-2.402,2-2.816v13.816c-.732,0-1.409.212-2,.556V5Z"/>
      </svg>
      Инструкция
    </button>
  </div>
</div>

<!-- Модальное окно инструкции -->
<div id="instructionsModal" class="modal hidden">
  <div class="modal-content" style="max-width: 600px;">
    <h2>
      <!-- SVG книги для заголовка инструкции -->
      <svg viewBox="0 0 24 24" style="width: 28px; height: 28px; vertical-align: middle; margin-right: 8px;">
        <path d="m17,10c-3.86,0-7,3.14-7,7s3.14,7,7,7,7-3.14,7-7-3.14-7-7-7Zm0,12c-2.757,0-5-2.243-5-5s2.243-5,5-5,5,2.243,5,5-2.243,5-5,5Zm1-4v2c0,.552-.448,1-1,1s-1-.448-1-1v-2c0-.552.448-1,1-1s1,.448,1,1Zm.5-3.5c0,.828-.672,1.5-1.5,1.5s-1.5-.672-1.5-1.5.672-1.5,1.5-1.5,1.5.672,1.5,1.5Zm-9.5,7.5h-5c-1.103,0-2-.897-2-2s.897-2,2-2h3c.552,0,1-.448,1-1s-.448-1-1-1h-1V2h9c1.654,0,3,1.346,3,3v2c0,.552.448,1,1,1s1-.448,1-1v-2c0-2.757-2.243-5-5-5H5C2.244,0,0,2.243,0,5v15C0,22.206,1.795,24,4,24h5c.552,0,1-.448,1-1s-.448-1-1-1ZM2,5c0-1.302.839-2.402,2-2.816v13.816c-.732,0-1.409.212-2,.556V5Z"/>
      </svg>
      Как играть
    </h2>
    <div style="margin: 20px 0;">
      <h3>
        <!-- SVG кубка для классической игры -->
        <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 8px; fill: var(--primary-color)">
          <path d="m14.09 16h.91c6.643 0 9-3.5 9-6.5a3.5 3.5 0 0 0 -2.84-3.433 7.564 7.564 0 0 0 .409-1 3.887 3.887 0 0 0 -.626-3.458 3.979 3.979 0 0 0 -3.214-1.609h-11.458a3.979 3.979 0 0 0 -3.214 1.612 3.887 3.887 0 0 0 -.626 3.458 7.564 7.564 0 0 0 .409 1 3.5 3.5 0 0 0 -2.84 3.43c0 3 2.357 6.5 9 6.5h.91a5.027 5.027 0 0 1 .09.921v3.079a1.883 1.883 0 0 1 -2 2h-2a1 1 0 0 0 0 2h12a1 1 0 0 0 0-2h-1.994a1.885 1.885 0 0 1 -2.006-2v-3.08a5.025 5.025 0 0 1 .09-.92zm1.636-2.851a23.486 23.486 0 0 0 4.4-5.225 1 1 0 0 0 .374.076 1.5 1.5 0 0 1 1.5 1.5c0 2.176-1.839 4.5-7 4.5h-.056a4.805 4.805 0 0 1 .782-.851zm-6.726.851c-5.161 0-7-2.324-7-4.5a1.5 1.5 0 0 1 1.5-1.5 1 1 0 0 0 .375-.076 23.486 23.486 0 0 0 4.4 5.225 4.805 4.805 0 0 1 .781.851z"/>
        </svg>
        Классическая игра
      </h3>
      <p><strong>Цель:</strong> Развивать навыки восприятия времени через последовательное прохождение уровней.</p>
      <p><strong>Как играть:</strong> Начните с первого подуровня уровня 1 и последовательно проходите все уровни. Каждый уровень содержит несколько подуровней с возрастающей сложностью. Новые подуровни открываются только после успешного прохождения предыдущих (с прогрессом не менее 80%).</p>
      <p><strong>Система прогресса:</strong> Ваши результаты сохраняются в рейтинговой таблице. Чем выше точность и скорость выполнения, тем больше очков вы получаете.</p>

      <h3>
        <!-- SVG мишени для тренировки -->
        <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 8px; fill: var(--success-color)">
          <path d="m17.009 5.577c.034-2.157.173-2.417.594-2.838.637-.637.607-.62.719-.732 1.016-1.016 1.889-1.21 2.375-.819.517.414.214 1.905.214 1.905s1.492-.304 1.905.214c.379.475.201 1.351-.823 2.375-.112.112-.094.081-.73.717-.487.487-.663.58-2.846.597l-3.711 3.711c-.391.391-1.023.391-1.414 0s-.391-1.023 0-1.414l3.716-3.716zm5.771 3.269c-.085-.544-.583-.917-1.143-.834-.546.085-.919.597-.834 1.143.13.834.196 1.792.196 2.846 0 6.561-2.439 9-9 9s-8.999-2.44-8.999-9.001 2.439-9 9-9c1.053 0 2.01.066 2.846.197.559.085 1.058-.289 1.143-.834.085-.546-.288-1.057-.834-1.143-.938-.146-1.999-.22-3.154-.22-7.711 0-11.001 3.29-11.001 11s3.29 11 11 11 11-3.29 11-11c0-1.173-.072-2.205-.22-3.154zm-8.783-2.737c.041-.551-.372-1.03-.923-1.071-.34-.025-.698-.038-1.074-.038-4.841 0-7 2.159-7 7s2.159 7 7 7 7-2.159 7-7c0-.376-.013-.734-.038-1.074-.041-.551-.514-.965-1.071-.923-.551.041-.964.52-.923 1.071.021.293.032.602.032.926 0 3.738-1.262 5-5 5s-5-1.262-5-5 1.262-5 5-5c.325 0 .633.01.926.032.54.041 1.03-.373 1.071-.923zm-2.763 3.644c-.373-.404-1.006-.432-1.413-.057-.553.51-.821 1.264-.821 2.304 0 1.991 1.009 3 3 3 1.041 0 1.795-.269 2.305-.821.374-.406.349-1.039-.058-1.413-.406-.375-1.038-.349-1.413.057-.049.054-.229.178-.834.178-.878 0-1-.122-1-1 0-.605.124-.785.178-.834.406-.375.431-1.007.057-1.413z"/>
        </svg>
        Тренировка
      </h3>
      <p><strong>Цель:</strong> Оттачивать конкретные навыки без влияния на рейтинг.</p>
      <p><strong>Как играть:</strong> Выберите любой уровень и подуровень для тренировки конкретных навыков. В тренировочном режиме доступны все подуровни независимо от прогресса в классической игре.</p>
      <p><strong>Особенности:</strong> Результаты тренировок не влияют на статистику и рейтинг. Идеально подходит для повторения сложных заданий или закрепления навыков.</p>

      <h3>
        <!-- SVG лампочки для уровней игры -->
        <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 8px; fill: var(--primary-color)">
          <path d="m5.868 15.583a8.938 8.938 0 0 1 -2.793-7.761 9 9 0 1 1 14.857 7.941 5.741 5.741 0 0 0 -1.594 2.237h-3.338v-7.184a3 3 0 0 0 2-2.816 1 1 0 0 0 -2 0 1 1 0 0 1 -2 0 1 1 0 0 0 -2 0 3 3 0 0 0 2 2.816v7.184h-3.437a6.839 6.839 0 0 0 -1.695-2.417zm2.132 4.417v.31a3.694 3.694 0 0 0 3.69 3.69h.62a3.694 3.694 0 0 0 3.69-3.69v-.31z"/>
        </svg>
        Уровни игры
      </h3>
      <ul style="padding-left: 20px; margin: 10px 0;">
        <li><strong>Уровень 1:</strong> Измерение времени и точность (3 подуровня)</li>
        <li><strong>Уровень 2:</strong> Рабочая память и поиск паттернов (3 подуровня)</li>
        <li><strong>Уровень 3:</strong> Логика и прогнозирование (2 подуровня)</li>
        <li><strong>Уровень 4:</strong> Стратегия и скорость (1 подуровень)</li>
      </ul>

      <h3>
        <!-- SVG медали для системы очков -->
        <svg xmlns="http://www.w3.org/2000/svg" id="Layer_1" data-name="Layer 1" viewBox="0 0 24 24" style="width: 20px; height: 20px; vertical-align: middle; margin-right: 8px; fill: #ffeb8c">
          <path d="m.439,6.561c-.586-.585-.586-1.536,0-2.121l2-2c.43-.43,1.075-.558,1.635-.325.561.232.926.779.926,1.386v9c0,.829-.672,1.5-1.5,1.5s-1.5-.671-1.5-1.5v-5.585c-.527.186-1.139.067-1.561-.354Zm14.561,1.439v-4c0-2.206,1.794-4,4-4s4,1.794,4,4v4c0,2.206-1.794,4-4,4s-4-1.794-4-4Zm3,0c0,.551.448,1,1,1s1-.449,1-1v-4c0-.551-.448-1-1-1s-1,.449-1,1v4Zm-12,1v-4c0-2.206,1.794-4,4-4s4,1.794,4,4v4c0,2.206-1.794,4-4,4s-4-1.794-4-4Zm3,0c0,.551.448,1,1,1s1-.449,1-1v-4c0-.551-.448-1-1-1s-1,.449-1,1v4Zm14.974,5.219c-.154-.814-.947-1.349-1.754-1.193L1.22,17.026c-.814.155-1.349.94-1.193,1.754.137.719.766,1.22,1.472,1.22.094,0,.188-.009.282-.027l21-4c.814-.155,1.349-.94,1.193-1.754Zm-1.757,4.308l-13,2.5c-.813.157-1.347.943-1.189,1.756.138.718.766,1.217,1.471,1.217.094,0,.189-.009.285-.027l13-2.5c.813-.157,1.347-.943,1.189-1.756-.156-.813-.942-1.347-1.756-1.19Z"/>
        </svg>
        Система очков
      </h3>
      <p>За точные действия получайте больше очков. Старайтесь достигать идеальной точности для максимального счета. Прогресс сохраняется автоматически.</p>
    </div>
    <div class="modal-buttons">
      <button onclick="hideInstructions()" class="btn btn-primary" aria-label="Закрыть инструкции и вернуться в меню">
        <!-- SVG галочки для кнопки "Понятно!" -->
        <svg viewBox="0 0 24 24" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 8px;">
          <path d="M9,20.42l-6.21-6.21,2.83-2.83L9,14.77l9.88-9.89,2.83,2.83Z"/>
        </svg>
        Понятно!
      </button>
    </div>
  </div>
</div>

<script src="js/dataManager.js"></script>
<script src="js/utils.js"></script>
<script>
  // Данные уровней
  const levelsData = {
    level1: {
      title: "Измерение времени",
      description: "Базовые навыки восприятия времени",
      sublevels: {
        "1-1": { id: "1-1", title: "Одна лампочка", description: "Определите время горения одной лампочки" },
        "1-2": { id: "1-2", title: "Летающие карточки", description: "Найдите правильное время среди движущихся карточек" },
        "1-3": { id: "1-3", title: "Двойной интервал", description: "Запомните два последовательных времени горения" }
      },
      color: "#acc8b8"
    },
    level2: {
      title: "Рабочая память",
      description: "Поиск паттернов среди отвлекающих факторов",
      sublevels: {
        "2-1": { id: "2-1", title: "Движущиеся лампочки", description: "Найдите целевую лампочку среди движущихся" },
        "2-2": { id: "2-2", title: "Найди время", description: "Найдите лампочку с нужным временем среди движущихся" },
        "2-3": { id: "2-3", title: "Повтори паттерн", description: "Запомните и повторите паттерн мигания" }
      },
      color: "#778fa3"
    },
    level3: {
      title: "Логика и прогнозирование",
      description: "Развитие логического мышления и предсказания",
      sublevels: {
        "3-1": { id: "3-1", title: "Ритмические последовательности", description: "Повторите порядок и длительность горения последовательности лампочек" },
        "3-2": { id: "3-2", title: "Математика времени", description: "Решите уравнение и найдите лампочку с нужным временем" }
      },
      color: "#9e82a3"
    },
    level4: {
      title: "Стратегия и скорость",
      description: "Комбинация скорости реакции и стратегического мышления",
      sublevels: {
        "4-1": { id: "4-1", title: "Лабиринт времени", description: "Запомните путь к лампочке за ограниченное время" }
      },
      color: "#d1b58b"
    }
  };

  // Выбранные уровни и подуровни
  let selectedLevel = 'level1';
  let selectedSublevel = "1-1";

  // Карусель переменные
  let currentSlide = 0;
  const slides = document.querySelectorAll('.carousel-card');
  const dots = document.querySelectorAll('.carousel-dot');
  const track = document.getElementById('carouselTrack');

  // Инициализация при загрузке
  document.addEventListener('DOMContentLoaded', () => {
    // Проверяем наличие текущего игрока
    const currentPlayer = DataManager.getPlayer();
    if (!currentPlayer) {
      // Показываем экран выбора профиля
      showProfileSelection();
      return;
    }

    // Считываем параметры URL (для возврата из тренировки)
    const urlParams = new URLSearchParams(window.location.search);
    const from = urlParams.get('from');
    const returnLevel = urlParams.get('level');
    const returnSublevel = urlParams.get('sublevel'); // формат X-Y

    // Если вернулись из тренировки, запоминаем желаемый слайд и выбор уровня/подуровня
    if (from === 'training' && returnLevel && returnSublevel) {
      window.initialCarouselSlide = 1; // 0 — классика, 1 — тренировка
      window.initialTrainingSelection = {
        levelId: returnLevel,
        sublevelId: returnSublevel
      };
    }

    // Загружаем все данные последовательно для предотвращения множественных пересчетов
    loadPlayerData().then(() => {
      // Применяем все изменения одновременно в следующем цикле перерисовки
      requestAnimationFrame(() => {
        renderUserPanel();
        renderClassicLevels();
        renderTrainingSelectors();

        // Инициализация карусели: если есть предварительный слайд — переходим на него
        if (typeof window.initialCarouselSlide === 'number') {
          currentSlide = window.initialCarouselSlide;
        }
        updateCarousel();

        // Выравниваем высоту карточек с user panel (один раз после загрузки)
        alignCarouselHeight();

        // Добавляем обработчики для стрелок
        document.querySelectorAll('.carousel-arrow').forEach(arrow => {
          arrow.style.visibility = 'visible';
          arrow.style.opacity = '1';
        });
      });
    });

    // Проверяем параметр refresh в URL
    if (urlParams.get('refresh') === '1') {
      console.log('[Menu] Обновление после возврата из игры');
      // Принудительное обновление данных
      setTimeout(() => {
        loadPlayerData().then(() => {
          requestAnimationFrame(() => {
            renderUserPanel();
            renderClassicLevels();
            renderTrainingSelectors();
            alignCarouselHeight();
          });
        });
      }, 100);
    }

    // Автоматическое обновление каждые 5 секунд
    setInterval(() => {
      if (window.player) {
        renderClassicLevels(); // Обновляем доступность уровней
      }
    }, 5000);
  });

  // Функция для обновления статистики игрока на основе прогресса
  function updatePlayerStats() {
    if (!window.player) return;

    const player = window.player;
    const progress = DataManager.getProgress() || {};

    // Пересчитываем статистику на основе прогресса
    let totalSublevelsCompleted = 0;
    let bestScore = 0;
    let totalScore = 0;

    // Считаем пройденные подуровни и лучший счет
    Object.keys(progress).forEach(levelKey => {
      const levelProgress = progress[levelKey];
      if (levelProgress) {
        Object.keys(levelProgress).forEach(sublevelKey => {
          const score = levelProgress[sublevelKey];
          if (score > 0) {
            totalSublevelsCompleted++;
            totalScore += score;
            if (score > bestScore) {
              bestScore = score;
            }
          }
        });
      }
    });

    // Это только для отображения в меню
    window.player.displayBestScore = bestScore;
    window.player.displayTotalScore = totalScore;
    window.player.displayCompletedSublevels = totalSublevelsCompleted;

    // Уровень игрока считаем на основе реальной статистики (игр сыграно)
    window.player.level = DataManager.calculatePlayerLevel(player);

    console.log('Статистика для отображения:', {
      bestScore,
      totalScore,
      totalSublevelsCompleted,
      gamesPlayed: player.gamesPlayed
    });
  }

  // Выравнивание высоты карточек карусели с user panel (оптимизировано для CLS)
  function alignCarouselHeight() {
    const userPanel = document.querySelector('.user-panel');
    const modeCards = document.querySelectorAll('.mode-card');

    if (userPanel && modeCards.length > 0) {
      // Используем getBoundingClientRect для точного измерения без пересчетов
      const userPanelHeight = userPanel.getBoundingClientRect().height;

      // Применяем высоту ко всем карточкам одновременно для предотвращения множественных пересчетов
      const heightValue = userPanelHeight + 'px';
      modeCards.forEach(card => {
        card.style.minHeight = heightValue;
      });

      // Обновляем высоту контейнера карусели
      const carouselContainer = document.querySelector('.carousel-container');
      if (carouselContainer) {
        carouselContainer.style.minHeight = heightValue;
      }
    }
  }

  // Функции карусели
  function nextSlide() {
    if (currentSlide < slides.length - 1) {
      currentSlide++;
      updateCarousel();
    }
  }

  function prevSlide() {
    if (currentSlide > 0) {
      currentSlide--;
      updateCarousel();
    }
  }

  function goToSlide(index) {
    currentSlide = index;
    updateCarousel();
  }

  function updateCarousel() {
    // Обновляем позицию трека
    track.style.transform = `translateX(-${currentSlide * 100}%)`;

    // Обновляем активную точку
    dots.forEach((dot, index) => {
      if (index === currentSlide) {
        dot.classList.add('active');
      } else {
        dot.classList.remove('active');
      }
    });

    // Обновляем состояние стрелок
    const prevArrow = document.querySelector('.carousel-arrow:first-child');
    const nextArrow = document.querySelector('.carousel-arrow:last-child');

    if (prevArrow) {
      if (currentSlide === 0) {
        prevArrow.classList.add('disabled');
      } else {
        prevArrow.classList.remove('disabled');
      }
    }

    if (nextArrow) {
      if (currentSlide === slides.length - 1) {
        nextArrow.classList.add('disabled');
      } else {
        nextArrow.classList.remove('disabled');
      }
    }
  }

  // Назначаем обработчики для точек
  dots.forEach((dot, index) => {
    dot.addEventListener('click', () => goToSlide(index));
    // Добавляем эффект при клике
    dot.addEventListener('click', function() {
      this.style.transform = 'scale(0.9)';
      setTimeout(() => {
        this.style.transform = '';
      }, 200);
    });
  });

  // Обработка клавиш для карусели
  document.addEventListener('keydown', (e) => {
    if (e.code === 'ArrowLeft') {
      prevSlide();
      addArrowClickEffect(document.querySelector('.carousel-arrow:first-child'));
    }
    if (e.code === 'ArrowRight') {
      nextSlide();
      addArrowClickEffect(document.querySelector('.carousel-arrow:last-child'));
    }
  });

  // Функция для эффекта клика на стрелке
  function addArrowClickEffect(arrow) {
    if (arrow) {
      arrow.style.transform = 'scale(0.9)';
      setTimeout(() => {
        arrow.style.transform = '';
      }, 200);
    }
  }

  // Добавляем эффекты при клике на стрелки
  document.querySelectorAll('.carousel-arrow').forEach(arrow => {
    arrow.addEventListener('click', function() {
      addArrowClickEffect(this);
    });
  });

  function loadPlayerData() {
    return new Promise((resolve) => {
      console.log('Загрузка данных игрока...');

      if (typeof DataManager === 'undefined') {
        console.error('DataManager не определен');
        window.location.href = 'index.html';
        resolve();
        return;
      }

      const player = DataManager.getPlayer();
      console.log('Получен игрок:', player);

      if (!player) {
        console.log('Игрок не найден, показываем экран выбора профиля');
        showProfileSelection();
        resolve();
        return;
      }

      window.player = player;

      // Загружаем прогресс
      const progress = DataManager.getProgress() || {};
      console.log('Получен прогресс:', progress);

      window.gameProgress = {
        level1: progress.level1 || {},
        level2: progress.level2 || {},
        level3: progress.level3 || {},
        level4: progress.level4 || {}
      };

      // Создаем экземпляр LevelManager для получения информации о разблокированных уровнях
      try {
        if (typeof LevelManager !== 'undefined') {
          // Создаем временный core объект для LevelManager
          const tempCore = {
            getGameMode: () => 'classic'
          };
          window.levelManagerInstance = new LevelManager(tempCore);
          console.log('LevelManager создан для меню');
        }
      } catch (error) {
        console.warn('Не удалось создать LevelManager для меню:', error);
      }

      console.log('Данные игрока загружены успешно');
      resolve();
    });
  }

  function renderUserPanel() {
    if (!window.player) return;

    const userPanel = document.getElementById('userPanel');
    const playerStats = DataManager.getPlayerStats();

    if (!playerStats) return;

    // Убираем класс loading перед рендерингом
    userPanel.classList.remove('loading');

    userPanel.innerHTML = `
    <div class="user-info">
        <div class="avatar-preview avatar-${playerStats.avatarId || 0} user-avatar-large"></div>
        <div class="user-details">
            <div class="user-name">${playerStats.name}</div>
            <div class="user-level">${playerStats.levelName}</div>
            <div class="user-sublevels">Подуровней пройдено: ${playerStats.completedSublevels || 0}/9</div>
        </div>
        <button onclick="showProfileSelection()" class="btn-logout" aria-label="Выйти из профиля" title="Выйти из профиля">
            <svg viewBox="0 0 24 24" style="width: 20px; height: 20px;">
                <path d="M16,17V14H9V10H16V7L21,12L16,17M14,2A2,2 0 0,1 16,4V6H14V4H5V20H14V18H16V20A2,2 0 0,1 14,22H5A2,2 0 0,1 3,20V4A2,2 0 0,1 5,2H14Z"/>
            </svg>
        </button>
    </div>
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number">${playerStats.gamesPlayed || 0}</div>
            <div class="stat-name">Игр сыграно</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">${playerStats.bestScore || 0}</div>
            <div class="stat-name">Лучший счет</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">${playerStats.totalScore || 0}</div>
            <div class="stat-name">Всего очков</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">${playerStats.completedSublevels || 0}</div>
            <div class="stat-name">Подуровней пройдено</div>
        </div>
    </div>
    `;
  }

  function renderClassicLevels() {
    const container = document.getElementById('compactLevelSelection');
    if (!container) return;

    // Убираем класс loading перед рендерингом
    container.classList.remove('loading');

    container.innerHTML = '';

    // Отображаем все 4 уровня
    Object.keys(levelsData).forEach((levelId, levelIndex) => {
      const levelData = levelsData[levelId];
      const progress = window.gameProgress[levelId] || {};

      const row = document.createElement('div');
      row.className = 'selection-row';
      row.dataset.level = levelId;

      // Индикатор уровня
      const indicator = document.createElement('div');
      indicator.className = 'level-indicator';
      indicator.innerHTML = `
                <div class="level-number">${levelIndex + 1}</div>
                <div class="level-name">Уровень</div>
            `;

      // Контейнер для подуровней
      const sublevelsContainer = document.createElement('div');
      sublevelsContainer.className = 'sublevels-container';

      // Создаем кнопки подуровней
      Object.values(levelData.sublevels).forEach((sublevel, subIndex) => {
        const sublevelId = sublevel.id;
        const sublevelScore = progress[sublevelId] || 0;

        // Определяем статус подуровня
        let status = 'locked';
        let isLocked = true;

        // Проверяем доступность
        if (isSublevelAvailable(levelId, sublevelId)) {
          status = sublevelScore > 0 ? 'completed' : 'available';
          isLocked = false;
        }

        // Проверяем, является ли этот подуровень текущим активным
        const isActive = (selectedLevel === levelId && selectedSublevel === sublevelId);

        const btn = document.createElement('button');
        btn.className = `sublevel-btn ${status} ${isActive ? 'active' : ''}`;
        btn.textContent = sublevelId;
        btn.dataset.level = levelId;
        btn.dataset.sublevel = sublevelId;
        btn.dataset.status = status;

        if (!isLocked) {
          btn.addEventListener('click', () => selectSublevel(levelId, sublevelId, status));
          btn.title = `${levelData.title}: Подуровень ${sublevelId}\n${sublevel.title}\n${sublevel.description}`;
        } else {
          btn.title = 'Этот подуровень еще не доступен';
        }

        sublevelsContainer.appendChild(btn);
      });

      row.appendChild(indicator);
      row.appendChild(sublevelsContainer);
      container.appendChild(row);
    });
  }

  function isSublevelAvailable(levelId, sublevelId) {
    // Используем единую логику из DataManager для проверки доступности
    return DataManager.isSublevelAvailable(levelId, sublevelId);
  }

  function selectSublevel(levelId, sublevelId, status) {
    selectedLevel = levelId;
    selectedSublevel = sublevelId;

    // Обновляем интерфейс
    renderClassicLevels();

    // Обновляем текст кнопки
    const levelData = levelsData[levelId];
    const sublevelData = levelData.sublevels[sublevelId];

    const btn = document.getElementById('startClassicBtn');
    if (btn && sublevelData) {
      if (status === 'completed') {
        btn.textContent = `Перепройти ${sublevelId}`;
      } else {
        btn.textContent = `Начать ${sublevelId}`;
      }
    }
  }

  function renderTrainingSelectors() {
    const levelSelect = document.getElementById('trainingLevelSelect');
    const sublevelSelect = document.getElementById('trainingSublevelSelect');
    const trainingSelection = document.querySelector('.training-selection');

    // Убираем класс loading перед рендерингом
    if (trainingSelection) {
      trainingSelection.classList.remove('loading');
    }

    // Очищаем селекторы
    levelSelect.innerHTML = '';
    sublevelSelect.innerHTML = '';

    // Заполняем селектор уровней
    Object.keys(levelsData).forEach((levelId, index) => {
      const levelData = levelsData[levelId];
      const option = document.createElement('option');
      option.value = levelId;
      option.textContent = `${levelId.replace('level', '')}. ${levelData.title}`;
      levelSelect.appendChild(option);
      // Если есть предварительный выбор из тренировки — используем его
      if (window.initialTrainingSelection && window.initialTrainingSelection.levelId === levelId) {
        option.selected = true;
      } else if (!window.initialTrainingSelection && index === 0) {
        // Если предварительного выбора нет — выбираем первый уровень по умолчанию
        option.selected = true;
      }
    });

    // Заполняем селектор подуровней для выбранного уровня
    updateTrainingSublevels();

    // Назначаем обработчики
    levelSelect.addEventListener('change', updateTrainingSublevels);
    sublevelSelect.addEventListener('change', updateTrainingPreview);

    // Обновляем превью
    updateTrainingPreview();
  }

  function updateTrainingSublevels() {
    const levelSelect = document.getElementById('trainingLevelSelect');
    const sublevelSelect = document.getElementById('trainingSublevelSelect');
    const levelId = levelSelect.value;
    const levelData = levelsData[levelId];

    if (!levelData) return;

    // Очищаем и заполняем селектор подуровней
    sublevelSelect.innerHTML = '';

    Object.values(levelData.sublevels).forEach((sublevel, index) => {
      const sublevelNum = sublevel.id.split('-')[1];
      const option = document.createElement('option');
      option.value = sublevelNum;
      option.textContent = `${sublevel.id}. ${sublevel.title}`;
      sublevelSelect.appendChild(option);
      // Если есть предварительный выбор из тренировки — используем его
      if (window.initialTrainingSelection && window.initialTrainingSelection.levelId === levelId && window.initialTrainingSelection.sublevelId === sublevel.id) {
        option.selected = true;
      } else if (!window.initialTrainingSelection && index === 0) {
        // Если предварительного выбора нет — выбираем первый подуровень по умолчанию
        option.selected = true;
      }
    });

    // Обновляем превью
    updateTrainingPreview();
  }

  function updateTrainingPreview() {
    const levelId = document.getElementById('trainingLevelSelect').value;
    const sublevelNum = parseInt(document.getElementById('trainingSublevelSelect').value);

    const levelData = levelsData[levelId];
    const sublevelId = `${levelId.replace('level', '')}-${sublevelNum}`;
    const sublevelData = levelData.sublevels[sublevelId];

    const previewContent = document.getElementById('previewContent');
    if (previewContent && sublevelData) {
      previewContent.innerHTML = `
                <strong>${levelData.title}</strong><br>
                <strong>Подуровень ${sublevelNum}: ${sublevelData.title}</strong><br>
                ${sublevelData.description}
            `;
    } else {
      previewContent.innerHTML = 'Пожалуйста, выберите доступный подуровень';
    }

    // Обновляем кнопку "Начать тренировку"
    const startTrainingBtn = document.getElementById('startTrainingBtn');
    startTrainingBtn.disabled = !sublevelData;
    startTrainingBtn.textContent = sublevelData ? 'Начать тренировку' : 'Выберите подуровень';
  }

  function calculateCompletedSublevels() {
    let completed = 0;
    const progress = DataManager.getProgress() || {};

    Object.keys(progress).forEach(levelKey => {
      const levelProgress = progress[levelKey];
      if (levelProgress) {
        Object.values(levelProgress).forEach(score => {
          if (score > 0) completed++;
        });
      }
    });
    return completed;
  }

  function calculateTotalSublevels() {
    let total = 0;
    Object.keys(levelsData).forEach(levelId => {
      const levelData = levelsData[levelId];
      if (levelData && levelData.sublevels) {
        total += Object.keys(levelData.sublevels).length;
      }
    });
    return total;
  }

  // УПРАВЛЕНИЕ ПРОФИЛЯМИ
  // Показать экран выбора профиля
  function showProfileSelection() {
    // Если есть текущий игрок, сохраняем его перед выходом
    const currentPlayer = DataManager.getPlayer();
    if (currentPlayer) {
      DataManager.logout();
    }

    const profileScreen = document.getElementById('profileSelectionScreen');
    const userPanel = document.getElementById('userPanel');
    const carouselContainer = document.querySelector('.carousel-container');
    const menuActions = document.querySelector('.menu-actions');

    if (profileScreen) {
      profileScreen.classList.remove('hidden');
      if (userPanel) userPanel.style.display = 'none';
      if (carouselContainer) carouselContainer.style.display = 'none';
      if (menuActions) menuActions.style.display = 'none';
    }

    renderProfilesList();
  }

  // Скрыть экран выбора профиля
  function hideProfileSelection() {
    const profileScreen = document.getElementById('profileSelectionScreen');
    const userPanel = document.getElementById('userPanel');
    const carouselContainer = document.querySelector('.carousel-container');
    const menuActions = document.querySelector('.menu-actions');

    if (profileScreen) {
      profileScreen.classList.add('hidden');
      if (userPanel) userPanel.style.display = '';
      if (carouselContainer) carouselContainer.style.display = '';
      if (menuActions) menuActions.style.display = '';
    }
  }

  // Отобразить список профилей
  function renderProfilesList() {
    const profilesList = document.getElementById('profilesList');
    if (!profilesList) return;

    const allPlayers = DataManager.getAllPlayers();
    const currentPlayer = DataManager.getPlayer();

    if (allPlayers.length === 0) {
      profilesList.innerHTML = `
                <div class="no-profiles-message">
                    <p>Нет сохраненных профилей</p>
                    <p style="color: var(--text-muted); font-size: 14px; margin-top: 10px;">
                        Создайте новый профиль, чтобы начать игру
                    </p>
                </div>
            `;
      return;
    }

    profilesList.innerHTML = allPlayers.map(player => {
      const isCurrent = currentPlayer && currentPlayer.id === player.id;
      const lastActiveDate = new Date(player.lastActive);
      const lastActiveText = formatLastActive(lastActiveDate);

      return `
                <div class="profile-card ${isCurrent ? 'current' : ''}" data-player-id="${player.id}">
                    <div class="profile-card-content">
                        <div class="profile-avatar">
                            <div class="avatar-preview avatar-${player.avatarId || 0} profile-avatar-large"></div>
                            ${isCurrent ? '<div class="current-badge">Текущий</div>' : ''}
                        </div>
                        <div class="profile-info">
                            <div class="profile-name">${player.name}</div>
                            <div class="profile-stats">
                                <span>Уровень: ${DataManager.getLevelName(player.level || 1)}</span>
                                <span>•</span>
                                <span>Игр: ${player.gamesPlayed || 0}</span>
                                <span>•</span>
                                <span>Очков: ${player.totalScore || 0}</span>
                            </div>
                            <div class="profile-last-active">Последний вход: ${lastActiveText}</div>
                        </div>
                        <div class="profile-actions">
                            ${!isCurrent ? `
                                <button onclick="switchToProfile('${player.id}')" class="btn btn-primary btn-small" aria-label="Переключиться на профиль ${player.name}">
                                    Выбрать
                                </button>
                            ` : ''}
                            <button onclick="deleteProfile('${player.id}', '${player.name}')" class="btn btn-danger btn-small" aria-label="Удалить профиль ${player.name}">
                                <svg viewBox="0 0 24 24" style="width: 16px; height: 16px;">
                                    <path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            `;
    }).join('');
  }

  // Форматировать дату последней активности
  function formatLastActive(date) {
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);

    if (diffMins < 1) return 'только что';
    if (diffMins < 60) return `${diffMins} мин. назад`;
    if (diffHours < 24) return `${diffHours} ч. назад`;
    if (diffDays < 7) return `${diffDays} дн. назад`;
    return date.toLocaleDateString('ru-RU');
  }

  // переключиться на другой профиль
  function switchToProfile(playerId) {
    if (DataManager.switchPlayer(playerId)) {
      // Перезагружаем страницу для применения изменений
      window.location.reload();
    } else {
      alert('Не удалось переключиться на профиль');
    }
  }

  // Создать новый профиль
  function createNewProfile() {
    window.location.href = 'index.html';
  }

  // Удалить профиль
  function deleteProfile(playerId, playerName) {
    if (!confirm(`Вы уверены, что хотите удалить профиль "${playerName}"?\n\nВсе данные этого профиля будут безвозвратно удалены.`)) {
      return;
    }

    if (DataManager.deletePlayer(playerId)) {
      // Если удалили текущий профиль, показываем экран выбора
      const currentPlayer = DataManager.getPlayer();
      if (!currentPlayer) {
        showProfileSelection();
      } else {
        renderProfilesList();
        loadPlayerData();
        renderUserPanel();
        renderClassicLevels();
      }
    } else {
      alert('Не удалось удалить профиль');
    }
  }

  function startSelectedLevel() {
    // Проверяем, авторизован ли игрок
    if (!window.player) {
      window.location.href = 'index.html';
      return;
    }

    // Проверяем, выбран ли подуровень
    if (!selectedLevel || !selectedSublevel) {
      alert('Пожалуйста, выберите уровень и подуровень');
      return;
    }

    // Проверяем, доступен ли выбранный подуровень
    if (!isSublevelAvailable(selectedLevel, selectedSublevel)) {
      alert('Этот подуровень еще не доступен. Сначала пройдите предыдущие подуровни.');
      return;
    }

    // Запускаем игру
    window.location.href = `game.html?level=${selectedLevel}&sublevel=${selectedSublevel}&mode=classic`;
  }

  function startTraining() {
    // Проверяем, авторизован ли игрок
    if (!window.player) {
      window.location.href = 'index.html';
      return;
    }

    const levelId = document.getElementById('trainingLevelSelect').value;
    const sublevelNum = parseInt(document.getElementById('trainingSublevelSelect').value);

    const levelData = levelsData[levelId];
    const formattedSublevelId = `${levelId.replace('level', '')}-${sublevelNum}`;
    const sublevelData = levelData.sublevels[formattedSublevelId];

    // Проверяем, что подуровень существует
    if (!sublevelData) {
      alert('Пожалуйста, выберите доступный подуровень');
      return;
    }

    // Запускаем тренировку
    window.location.href = `game.html?level=${levelId}&sublevel=${formattedSublevelId}&mode=training`;
  }

  function showInstructions() {
    document.getElementById('instructionsModal').classList.remove('hidden');
  }

  function hideInstructions() {
    document.getElementById('instructionsModal').classList.add('hidden');
  }

  // Обработка клавиши Escape
  document.addEventListener('keydown', (e) => {
    if (e.code === 'Escape' && !document.getElementById('instructionsModal').classList.contains('hidden')) {
      hideInstructions();
    }
  });

  // Обновление данных при возвращении на страницу
  document.addEventListener('visibilitychange', () => {
    if (!document.hidden) {
      // Страница стала видимой - обновляем данные
      setTimeout(() => {
        loadPlayerData();
        renderUserPanel();
        renderClassicLevels();
        renderTrainingSelectors();
      }, 100);
    }
  });

  // Обновление данных при загрузке из кэша
  window.addEventListener('pageshow', (event) => {
    if (event.persisted) {
      // Страница загружена из кэша браузера
      loadPlayerData();
      renderUserPanel();
      renderClassicLevels();
      renderTrainingSelectors();
    }
  });

  // Обновление высоты при изменении размера окна
  window.addEventListener('resize', alignCarouselHeight);

  function findFirstAvailableSublevel() {
    // Ищем первый доступный подуровень для продолжения игры
    for (let levelId of Object.keys(levelsData)) {
      const levelData = levelsData[levelId];
      const progress = window.gameProgress[levelId] || {};

      for (let sublevel of levelData.sublevels) {
        if (isSublevelAvailable(levelId, sublevel.id)) {
          const sublevelScore = progress[sublevel.id] || 0;
          if (sublevelScore < 500) { // Если подуровень не пройден полностью
            return { level: levelId, sublevel: sublevel.id };
          }
        }
      }
    }

    // Если все пройдены, возвращаем последний подуровень последнего уровня
    const lastLevel = Object.keys(levelsData).pop();
    const lastLevelData = levelsData[lastLevel];
    const lastSublevel = lastLevelData.sublevels[lastLevelData.sublevels.length - 1];
    return { level: lastLevel, sublevel: lastSublevel.id };
  }

  // Обработчик перед закрытием
  window.addEventListener('beforeunload', () => {
    try {
      if (window.LevelManager && window.LevelManager.currentInstance) {
        window.LevelManager.currentInstance.clearTimers();
      }
    } catch (error) {
      console.error('Ошибка очистки таймеров при выходе из меню:', error);
    }
  });
</script>
</body>
</html>
